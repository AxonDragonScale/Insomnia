name: Build and Release

on:
  # Trigger on version tags
  push:
    tags:
      - 'v*'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

env:
  PROJECT_NAME: Insomnia
  SCHEME: Insomnia

jobs:
  build:
    name: Build and Create Release
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Release
        run: |
          xcodebuild -project "$PROJECT_NAME.xcodeproj" \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -derivedDataPath build/DerivedData \
                     CODE_SIGN_IDENTITY="-" \
                     CODE_SIGN_STYLE=Manual \
                     DEVELOPMENT_TEAM="" \
                     SYMROOT=build \
                     build

      - name: Verify build
        run: |
          if [ ! -d "build/Release/$PROJECT_NAME.app" ]; then
            echo "❌ Build failed: $PROJECT_NAME.app not found"
            exit 1
          fi
          echo "✓ Build succeeded"

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME="$PROJECT_NAME-$VERSION.dmg"

          # Create temporary folder with app and Applications symlink
          mkdir -p build/dmg_temp
          cp -R "build/Release/$PROJECT_NAME.app" build/dmg_temp/
          ln -s /Applications build/dmg_temp/Applications

          # Create DMG
          hdiutil create -volname "$PROJECT_NAME" \
                         -srcfolder build/dmg_temp \
                         -ov -format UDZO \
                         "build/$DMG_NAME"

          rm -rf build/dmg_temp
          echo "✓ Created $DMG_NAME"

      - name: Create ZIP
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="$PROJECT_NAME-$VERSION.zip"

          cd build/Release
          zip -r -q "../$ZIP_NAME" "$PROJECT_NAME.app"
          cd ../..

          echo "✓ Created $ZIP_NAME"

      - name: Generate checksums
        id: checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd build

          DMG_NAME="$PROJECT_NAME-$VERSION.dmg"
          ZIP_NAME="$PROJECT_NAME-$VERSION.zip"

          DMG_SHA=$(shasum -a 256 "$DMG_NAME" | awk '{print $1}')
          ZIP_SHA=$(shasum -a 256 "$ZIP_NAME" | awk '{print $1}')

          echo "dmg_sha=$DMG_SHA" >> $GITHUB_OUTPUT
          echo "zip_sha=$ZIP_SHA" >> $GITHUB_OUTPUT

          # Create checksum files
          echo "$DMG_SHA  $DMG_NAME" > "$DMG_NAME.sha256"
          echo "$ZIP_SHA  $ZIP_NAME" > "$ZIP_NAME.sha256"

          echo "✓ Checksums generated"
          echo "  DMG: $DMG_SHA"
          echo "  ZIP: $ZIP_SHA"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.PROJECT_NAME }} v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation

            1. Download `${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.dmg`
            2. Open the DMG and drag **${{ env.PROJECT_NAME }}** to your Applications folder
            3. First launch: **Right-click → Open → Open** (required for unsigned apps)

            See [INSTALL.md](https://github.com/${{ github.repository }}/blob/main/INSTALL.md) for detailed instructions.

            ## Checksums (SHA256)

            | File | SHA256 |
            |------|--------|
            | `${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.dmg` | `${{ steps.checksums.outputs.dmg_sha }}` |
            | `${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.zip` | `${{ steps.checksums.outputs.zip_sha }}` |

            ## Verify Download

            ```bash
            shasum -a 256 ~/Downloads/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.dmg
            ```
          files: |
            build/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.dmg
            build/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.zip
            build/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.dmg.sha256
            build/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
